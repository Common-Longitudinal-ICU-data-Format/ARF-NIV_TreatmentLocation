---
title: "04_ARF_IMC_generate_summary_coeff"
author: "Sarah Goldfarb"
date: "2026-01-13"
output: html_document
---

# Load the Required Packages, specify local paths
```{r Load Needed Libraries, include=FALSE}
packages <- c(
  "tidyverse",
  "yaml",
  "rprojroot",
  "metafor",
  "meta"
)

install_if_missing <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package, dependencies = TRUE)
    library(package, character.only = TRUE)
  }
}

sapply(packages, install_if_missing)
rm(packages, install_if_missing)

# Find project root
project_root <- find_root(rprojroot::has_dir("config"))

# Read YAML config
config <- yaml::read_yaml(file.path(project_root, "config", "config.yaml"))
global_config <- yaml::read_yaml(file.path(project_root, "config", "global_config.yaml"))

if(config$institution != "Hopkins"){
  stop("proceed to next file")
}

# Assign config values to R variables
project_location <- config$project_location
outcomes <- global_config$outcomes

rm(config, global_config)
```

# Define sites, outcomes
```{r}

# Sites and outcomes
sites <- c("Hopkins")

# Output directory for global model outcomes
if (!dir.exists(paste0(project_location, "/global_model_outputs"))) {
  dir.create(paste0(project_location, "/global_model_outputs"))}
global_out_dir <- file.path(project_location, "global_model_outputs")

```

```{r}
# Get site folder path
site_export_dir <- function(site) {
  file.path(paste0(project_location, 
            site, 
            "_project_output/",
            site,
            "_model_coefficients.csv"))
}

```

```{r}

model_coefficients <- data.frame(
  site = character(),
  hospital = character(),
  imc_capable = character(),
  academic_community = character(),
  outcome=character(),
  beta=numeric(),
  beta_error=numeric(),
  n_obs=integer(),
  risk_difference=numeric(),
  risk_difference_error=numeric(),
  stringsAsFactors = FALSE
  # ADD P VALUES
)

# Iterate over each site, load in model outputs
for(s in sites){
  model_coefficients <- model_coefficients |>
    add_row(
      read_csv(site_export_dir(site=s), show_col_types=FALSE)
    )
}
```

```{r}

meta_analysis_0 <- rma(
  data=model_coefficients,
  yi=beta,
  sei=beta_error,
  method="REML"
)

meta_analysis_0


meta_analysis <- rma(
  data=model_coefficients,
  yi=beta,
  sei=beta_error,
  method="REML",
  mods= ~ imc_capable + academic_community
)

meta_analysis

meta_analysis_2 <- rma(
  data=model_coefficients,
  yi=risk_difference,
  sei=risk_difference_error,
  method="REML",
  mods= ~ imc_capable + academic_community
)

summary(meta_analysis_2)
```

```{r}
meta1 <- metagen(
  data=model_coefficients,
  TE=beta,
  seTE=beta_error,
  method.tau="REML",
  common=F, # Do not want common effect (only want random)
  random=T, # I want to report random effects
  sm="OR"#,
  #mods= ~ imc_capable + academic_community
)

forest(meta1, layout="JAMA")
# Find a way to size the points based on n_obs
```