---
title: "04_ARF_IMC_generate_summary_coeff"
author: "Sarah Goldfarb"
date: "2026-01-13"
output: html_document
---

# Load the Required Packages, specify local paths
```{r Load Needed Libraries, include=FALSE}
packages <- c(
  "tidyverse",
  "yaml",
  "rprojroot"
)

install_if_missing <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package, dependencies = TRUE)
    library(package, character.only = TRUE)
  }
}

sapply(packages, install_if_missing)
rm(packages, install_if_missing)

# Find project root
project_root <- find_root(rprojroot::has_dir("config"))

# Read YAML config
config <- yaml::read_yaml(file.path(project_root, "config", "config.yaml"))
global_config <- yaml::read_yaml(file.path(project_root, "config", "global_config.yaml"))

if(config$institution != "Hopkins"){
  stop("proceed to next file")
}

# Assign config values to R variables
project_location <- config$project_location
outcomes <- global_config$outcomes

rm(config, global_config)
```

# Define sites, outcomes
```{r}

# Sites and outcomes
sites <- c("Hopkins")

# Output directory for global model outcomes
if (!dir.exists(paste0(project_location, "/global_model_outputs"))) {
  dir.create(paste0(project_location, "/global_model_outputs"))}
global_out_dir <- file.path(project_location, "global_model_outputs")

# Clean outcome name to match local naming convention
outcome_tag <- function(outcome) gsub("[^A-Za-z0-9_]+", "_", outcome)

```

```{r}
# Get site folder path
site_export_dir <- function(site, tab_type, outcome_tag) {
  file.path(paste0(project_location, 
            site, 
            "_project_output/local_propensities/",
            site,
            "_local_",
            tab_type, "_",
            outcome_tag, ".csv"))
}

```

```{r}

# Iterate over each outcome
for(outcome in outcomes){
  # Initialize list within an outcome
  estimate_list = list()
  cov_list = list()
  
  # Iterate over each site
  for (site in sites){
    
    estimate_list[[site]] <- read_csv(site_export_dir(site, "estimates", outcome), show_col_types = FALSE, name_repair = "minimal") |>
      rename(iteration=1)
    
    cov_list[[site]] <- read_csv(site_export_dir(site, "covariances", outcome), show_col_types = FALSE, name_repair = "minimal") |>
      rename(term=1)
    
    
    # DO WEIGHTING HERE
  }
}
```
