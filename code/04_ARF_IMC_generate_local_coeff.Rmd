---
title: "03_ARF_IMC_generate_local_coeff"
author: "Sarah Goldfarb"
date: "2026-01-13"
output: html_document
---

# Load the Required Packages
```{r Load Needed Libraries, include=FALSE}
packages <- c(
  "tidyverse",
  "yaml",
  "rprojroot",
  "stringr",
  "lmtest",
  "sandwich"
)

install_if_missing <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package, dependencies = TRUE)
    library(package, character.only = TRUE)
  }
}

sapply(packages, install_if_missing)
rm(packages, install_if_missing)
```

# Load config to specify local paths
```{r Use YAML config to define values to R variables}
# Find project root
project_root <- find_root(rprojroot::has_dir("config"))

# Read YAML config
config <- yaml::read_yaml(file.path(project_root, "config", "config.yaml"))
gobal_config <- yaml::read_yaml(file.path(project_root, "config", "global_config.yaml"))

# Assign config values to R variables
tables_location <- config$tables_location
project_location <- config$project_location
site <- config$institution
site_time_zone <- config$time_zone

file_type <- gobal_config$file_type
covariates <- gobal_config$covariates
outcomes <- gobal_config$outcomes

rm(config, gobal_config)
```

# Create folders if needed
```{r Create folders if needed, include=FALSE}
#Create Sub Folders within Project Folder
# Check if the output directory exists; if not, create it
if (!dir.exists(paste0(project_location, "/private_tables"))) {
  dir.create(paste0(project_location, "/private_tables"))
}
if (!dir.exists(paste0(project_location, "/", site, "_project_output"))) {
  dir.create(paste0(project_location,"/", site, "_project_output"))
}
if (!dir.exists(paste0(project_location, "/", site, "_project_output/local_propensities"))) {
  dir.create(paste0(project_location,"/", site, "_project_output/local_propensities"))
}
if (!dir.exists(paste0(project_location, "/", site, "_project_output/sensitivity_analysis/local_propensities"))) {
  dir.create(paste0(project_location,"/", site, "_project_output/sensitivity_analysis/local_propensities"))
}

export_dir <- file.path(paste0(project_location, "/", site, "_project_output/local_propensities/", site,"_local_"))
export_dir_no_pandemic <- file.path(paste0(project_location, "/", site, "_project_output/sensitivity_analysis/local_propensities/", site,"_no_pandemic_local_"))
```

# Reading in data
```{r Read in cohort}
final_cohort <- read_csv(paste0(project_location, "/private_tables/one_encounter_per_pt_with_stratification.csv"), show_col_types=FALSE)
no_pandemic_cohort <- read_csv(paste0(project_location, "/private_tables/no_pandemic_one_encounter_per_pt_with_stratification.csv"), show_col_types=FALSE)

reformat_cohort_cols <- function(df) {
  
  # Set order of triage location for foactoring
  traige_location_factors <- c("ICU", "IMC", "Ward")
  traige_location_imc_factors <- c("ICU (+)", "ICU (-)", "IMC", "Ward (+)", "Ward (-)")
  
  
  return(df |>
  mutate(
    # Format triage location
    triage_location_formatted = case_when(
      triage_location == "icu" ~ "ICU",
      triage_location == "stepdown" ~ "IMC",
      triage_location == "ward" ~ "Ward",
      TRUE ~ triage_location),
    # Set triage location as factor
    triage_location_formatted = factor(triage_location_formatted, levels = traige_location_factors),
    # Categorize triage location based on IMC availability
    traige_location_imc_avail = case_when(
      triage_location_formatted == "ICU" & imc_capable == 1 ~ "ICU (+)",
      triage_location_formatted == "ICU" ~ "ICU (-)",
      triage_location_formatted == "IMC" ~ "IMC",
      triage_location_formatted == "Ward" & imc_capable == 1 ~ "Ward (+)",
      triage_location_formatted == "Ward" ~ "Ward (-)",
      TRUE ~ triage_location_formatted
    ),
    # Set triage  as factor
    traige_location_imc_avail = factor(traige_location_imc_avail, levels = traige_location_imc_factors),
    # Factor race
    race_summary = factor(race_summary, levels=c("White", "Black or African American", "Asian", "Other")),
    # Factor last NIV device
    last_niv_device = factor(last_niv_device, levels=c("NIPPV", "High Flow NC")),
    # Factor type of ARF
    physiologic_type = factor(physiologic_type, levels=c("Hypoxic", "Hypercapnic", "Mixed", "Neither", "Undefined")),
    # Create binary variable if patient is female
    is_female = ifelse(tolower(sex_category) == "female", 1, 0),
    
    # Binary variable if patient had imv (set as NA if patient was DNI)
    imv = ifelse(is_dni, NA, ifelse(was_trach == 1 | was_intubated == 1, 1, 0)),
    
    # Binary variable if patient died or discharged to hospice at all
    death_hospice = ifelse(in_hosp_death == 1 | hospice == 1, 1, 0),
    
    # Create log10 scale for relevant variables
    los_pen_logged = log10(los_penalized),
    
    # Create indicator variable for whether patient was admitted to ICU, stepdown, ward
    icu_admit = ifelse(triage_location_formatted == "ICU", 1, 0),
    imc_admit = ifelse(triage_location_formatted == "IMC", 1, 0),
    ward_admit = ifelse(triage_location_formatted == "Ward", 1, 0),
    
    
    # Binary variable if patient died or discharged to hospice within the given unit level
    death_hospice_icu = case_when(
      icu_admit == 1 & death_hospice == 1 ~ 1,
      icu_admit == 1 & death_hospice == 0 ~ 0,
      TRUE ~ NA
    ),
    death_hospice_imc = case_when(
      imc_admit == 1 & death_hospice == 1 ~ 1,
      imc_admit == 1 & death_hospice == 0 ~ 0,
      TRUE ~ NA
    ),
    death_hospice_ward = case_when(
      ward_admit == 1 & death_hospice == 1 ~ 1,
      ward_admit == 1 & death_hospice == 0 ~ 0,
      TRUE ~ NA
    ),
    first_hospital_id = factor(first_hospital_id)
    
  ))
}

final_cohort <- reformat_cohort_cols(final_cohort)
no_pandemic_cohort <- reformat_cohort_cols(no_pandemic_cohort)
```

```{r}
#Keep Track of the Number of Hospitals
n_hospitals <- length(unique(final_cohort$first_hospital_id[!is.na(final_cohort$first_hospital_id)]))

n_hospitals_no_pandemic <- length(unique(no_pandemic_cohort$first_hospital_id[!is.na(no_pandemic_cohort$first_hospital_id)]))
```

```{r Function to Summarise Logistic Regression Models}
model_summary_table <- function(model, n_hospitals) {
 
#Uses Fixed Effects for Hospital in Sites with > 1 Hospital (and clustered standard errors)  
if (n_hospitals>1) {
  #Cluster Robust Standard Errors Using LM Test
  coef_table <- coeftest(model, 
                         vcovCL(model, cluster = model.frame(model)$hospital_id)) 
  # Cluster-robust covariance matrix
  clustered_se <- vcovCL(model, cluster = model.frame(model)$hospital_id)
  #Compute confidence intervals manually using the clustered SE
  conf_int <- coefci(model, vcov. = clustered_se)
}  else {
  coef_table <- coeftest(model)
  conf_int <- coefci(model)
}
 model_table <- data.frame(
  'site' = site,
  'n_observations' = nobs(model),
  'term' = rownames(coef_table),
  'estimate' = coef_table[, "Estimate"],
  'std_error' = coef_table[, "Std. Error"],
  'p_value' = coef_table[, "Pr(>|z|)"],
  'odds_ratio' = round(exp(coef_table[, "Estimate"]), 3),  # Exponentiated coefficients as Odds Ratios
  'lower_bound' = exp(conf_int[, 1]),  # Lower bound of CI from coefci()
  'upper_bound' = exp(conf_int[, 2])   # Upper bound of CI from coefci()
)
model_table <- model_table |>
  mutate(confidence_interval=paste0(round(lower_bound, 3), ' - ', round(upper_bound, 3))) |>
  mutate(n_hospitals=n_hospitals) |>
  relocate(confidence_interval, .before = lower_bound) |>
  relocate(n_hospitals, .after = n_observations) 
  rownames(model_table) <- NULL
return(model_table)
}
```

# Fit export coef/vcov to prepare for global pooling
```{r}
# Generate propensity score (do not include triage location or hospital here) for each outcome
generate_coef_vcov <- function(cohort_information, n_hospitals, export_dir){
  
# Iterate over each outcome
  for (outcome in outcomes){
    
    
    # ------------
    # Define model and data
    # ------------
    
    # Define model formula
    model_form <- as.formula(paste0(outcome, " ~ ", paste(covariates, collapse = " + ")))
    
    # Define the columns needed to run regression 
    # Need hospital ID to save propensities
    needed_cols <- c("first_hospital_id", outcome, covariates)
  
    # Subset dataframe if looking at outcome set to only that cohort
    if(str_ends(outcome, "_icu")){
      df <- cohort_information |>
        dplyr::filter(triage_location_formatted == "ICU")
      cat("Subsetted to ICU for outcome: ", outcome,"\n")
    } else if(str_ends(outcome, "_imc")){
      df <- cohort_information |>
        dplyr::filter(triage_location_formatted == "IMC")
      cat("Subsetted to IMC for outcome: ", outcome,"\n")
    } else if(str_ends(outcome, "_ward")){
      df <- cohort_information |>
        dplyr::filter(triage_location_formatted == "Ward")
      cat("Subsetted to Ward for outcome: ", outcome,"\n")
    }
    else{
      df <- cohort_information
      cat("No subset for outcome: ", outcome,"\n")
    }
    
    # Selecting only needed columns, requiring all to have data
    df <- df |>
      select(dplyr::all_of(needed_cols)) |>
      drop_na()
    
    # Basic safety checks
    if (nrow(df) < 50){
      warning("Too few complete-case rows for ", outcome, ": n=", nrow(df))
      next
    } 
    if (!all(df[[outcome]] %in% c(0, 1))) {
      warning("Outcome must be coded 0/1 for ", outcome)
      next
    }
    if (n_distinct(df[[outcome]]) < 2){
      warning("Outcome has no variation after filtering for ", outcome)
      next
    }
  
    # ------------
    # Fit a local GLM and export coeffs
    # ------------
    
    # Run GLM
    mod <- glm(model_form,
               data = df, 
               family=binomial)
    
    #Collect Coefficient and Covariance Matrix for Centralized Creation of Global Coefficient
    propensity_build_estimates <- model_summary_table(mod, n_hospitals=n_hospitals) |>
      # Set <5 as NA to ensure patient privacy
      mutate(n_observations = ifelse(n_observations >= 5, n_observations, NA_integer_))
    
    propensity_build_covariance <- as.data.frame(vcov(mod))
  
    write.csv(propensity_build_estimates, paste0(export_dir, "estimates_",outcome, '.csv'))
  
    write.csv(propensity_build_covariance, paste0(export_dir, "covariances_",outcome, '.csv'))
  
    # ------------
    # Log complete message
    # ------------
    cat("Exported local coef/vcov for outcome: ", outcome, "\n\n")
  
  }
}
```
# Run for main cohorts and for no pandemic era cohorts
```{r}
generate_coef_vcov(final_cohort, n_hospitals, export_dir)
```

```{r}
generate_coef_vcov(no_pandemic_cohort, n_hospitals_no_pandemic, export_dir_no_pandemic)
```