---
title: "testing_2"
author: "Sarah Goldfarb"
date: "2026-01-20"
output: html_document
---


# Load the Required Packages
```{r Load Needed Libraries, include=FALSE}
packages <- c(
  "tidyverse",
  "lubridate",
  "arrow",
  "yaml",
  "rprojroot",
  "data.table",
  "zoo",
  "comorbidity",
  "fst",   
  "tictoc" 
)


install_if_missing <- function(package) {
  if (!require(package, character.only = TRUE)) {
    install.packages(package, dependencies = TRUE)
    library(package, character.only = TRUE)
  }
}

sapply(packages, install_if_missing)
rm(packages, install_if_missing)

#Use Dplyr functions as default
filter <- dplyr::filter
mutate <- dplyr::mutate
select <- dplyr::select
arrange <- dplyr::arrange
group_by <- dplyr::group_by
summarise <- dplyr::summarise
lead <- dplyr::lead
lag <- dplyr::lag
coalesce <- dplyr::coalesce
n <- dplyr::n

```

# Load config to specify local paths
```{r Use YAML config to define values to R variables}
# Find project root
project_root <- find_root(rprojroot::has_dir("config"))

# Read YAML config
config <- yaml::read_yaml(file.path(project_root, "config", "config.yaml"))

# Assign config values to R variables
tables_location <- config$tables_location
project_location <- config$project_location
site <- config$institution
site_time_zone <- config$time_zone
file_type <- config$file_type

# Study start and end
STUDY_START <- as.POSIXct(config$study_start, tz=site_time_zone) # Start time
STUDY_END <- as.POSIXct(config$study_end, tz=site_time_zone) # End time

```

```{r Create folders if needed}
#Create Sub Folders within Project Folder
# Check if the output directory exists; if not, create it
if (!dir.exists(paste0(project_location, "/private_tables"))) {
  dir.create(paste0(project_location, "/private_tables"))
}
```

# Load the Required CLIF Tables
```{r Specify required CLIF tables}
#List of table names from CLIF 2.0
tables <- c("patient", "hospitalization", "vitals", "labs", 
            "medication_admin_continuous", "adt", 
            "patient_assessments", "respiratory_support", "position", 
            "dialysis", "intake_output", "ecmo_mcs", "procedures", 
            "admission_diagnosis", "provider", "sensitivity", 
            "medication_orders", "medication_admin_intermittent", 
            "therapy_details", "microbiology_culture", "sensitivity", "microbiology_nonculture", "hospital_diagnosis")

# Tables that should be set to TRUE for this project
true_tables <- c("microbiology_culture")

# Create a named vector and set the boolean values
table_flags <- setNames(tables %in% true_tables, tables)
```

```{r Load relevant CLIF tables, include=FALSE}
# List all CLIF files in the directory
clif_table_filenames <- list.files(path = tables_location, 
                                   pattern = paste0("^clif_.*\\.", file_type, "$"), 
                                   full.names = TRUE)

# Extract the base names of the files (without extension)
clif_table_basenames <- basename(clif_table_filenames) |>
  str_remove(paste0("\\.", file_type, "$"))

# Create a lookup table for required files based on table_flags
required_files <- paste0("clif_", names(table_flags)[table_flags])

# Check if all required files are present
missing_tables <- setdiff(required_files, clif_table_basenames)
if (length(missing_tables) > 0) {
  stop(paste("Error: Missing required tables:", paste(missing_tables, collapse = ", ")))
}

# Filter only the filenames that are required
required_filenames <- clif_table_filenames[clif_table_basenames %in% required_files]

# Define the cast function to convert large_string to string
cast_large_utf8_to_utf8 <- function(x) {
  # Only applies to Arrow objects that have a schema()
  # (open_dataset() returns an Arrow Dataset / query)
  sch <- arrow::schema(x)

  large_cols <- vapply(
    sch$fields,
    function(f) f$type$ToString() %in% c("large_string", "large_utf8"),
    logical(1)
  )

  cols_to_cast <- sch$names[large_cols]
  if (length(cols_to_cast) == 0) return(x)

  x %>% mutate(across(all_of(cols_to_cast), ~ arrow::cast(.x, arrow::utf8())))
}

# Read the required files into a list of data frames
if (file_type == "parquet") {
  data_list <- lapply(required_filenames, open_dataset)
  # Apply cast function to normalize Arrow string types right after import
  data_list <- lapply(data_list, cast_large_utf8_to_utf8)
} else if (file_type == "csv") {
  data_list <- lapply(required_filenames, read_csv)
} else if (file_type == "fst") {
  data_list <- lapply(required_filenames, read.fst)
} else {
  stop("Unsupported file format")
}

# Assign the data frames to variables based on their file names
for (i in seq_along(required_filenames)) {
  # Extract the base name of the file (without extension)
  object_name <- str_remove(basename(required_filenames[i]), paste0("\\.", file_type, "$"))
  # Make the object name valid for R (replace invalid characters with underscores)
  object_name <- make.names(object_name)
  # Assign the tibble to a variable with the name of the file
  assign(object_name, data_list[[i]])
}
```

# Reading in data
```{r Read in cohort and hospital block information}
# Cohort information
final_cohort <- read_csv(paste0(project_location, "/private_tables/all_encounters.csv"), show_col_types=FALSE)
# Hospital block to hospitalization id key
hospital_block_key <- read_csv(paste0(project_location, "/private_tables/hospital_block_key.csv"), show_col_types=FALSE)
# Outlier thresholds
outlier_thresholds <- read_csv(paste0(project_location, "/outlier-thresholds/project_outlier_thresholds.csv"), show_col_types=FALSE)
```



```{r}
# hospitalizations <- final_cohort |>
#   select(patient_id, hospital_block_id) |>
#   # Mutate so that the column takes only the string that occurs after the underscore, stored as a character type
#   mutate(hospitalization_id = str_extract(hospital_block_id, "(?<=_).*")) |>
#   distinct()
# 
# hospital_block_key_obj<- 
#   arrow::arrow_table(hospitalizations |>
#   # ensure same datatype
#   mutate(patient_id = as.character(patient_id),
#       hospitalization_id = as.character(hospitalization_id)))


hospital_block_key_obj <- 
  arrow::arrow_table(
  hospital_block_key |>
    select(patient_id,
           hospitalization_id,
           hospital_block_id,
           block_start_admit,
           block_end_discharge,
           discharge_location) |>
  # ensure same datatype
  mutate(patient_id = as.character(patient_id),
      hospitalization_id = as.character(hospitalization_id)))
```


# Create hospital blocks for all relevant CLIF tables
```{r Add hospital blocks to all relevant CLIF tables}




clif_microbiology_culture <- clif_microbiology_culture |>
  # ensure same datatype
  mutate(hospitalization_id = as.character(hospitalization_id)) |>
  inner_join(hospital_block_key_obj, by = c("hospitalization_id")) |>
  compute()




clif_microbiology_culture |>
  head(1000)|>
  collect()
```
